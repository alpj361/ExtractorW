/**
 * Script de prueba para el sistema h√≠brido LLM de Vizta
 * Prueba tanto el modo conversacional como el modo ag√©ntico
 */

const { agentesService } = require('./server/services/agentesService');

// Configuraci√≥n de pruebas
const TEST_USER = {
  id: 'test-user-123',
  email: 'test@example.com',
  role: 'admin'
};

const SESSION_ID = `test_session_${Date.now()}`;

/**
 * Ejecutar una consulta de prueba
 */
async function testQuery(query, description = '') {
  console.log(`\n${'='.repeat(80)}`);
  console.log(`üß™ PRUEBA: ${description || query}`);
  console.log(`üìù Query: "${query}"`);
  console.log(`${'='.repeat(80)}`);
  
  const startTime = Date.now();
  
  try {
    const result = await agentesService.processUserQuery(query, TEST_USER, SESSION_ID);
    const processingTime = Date.now() - startTime;
    
    console.log(`\n‚úÖ RESPUESTA EXITOSA (${processingTime}ms):`);
    console.log(`üì® Agente: ${result.response.agent}`);
    console.log(`üéØ Intenci√≥n: ${result.metadata.intent} (${result.metadata.intentMethod})`);
    console.log(`üß† Confianza: ${result.metadata.intentConfidence}`);
    console.log(`üîß Modo: ${result.metadata.mode}`);
    console.log(`üí¨ Mensaje: "${result.response.message}"`);
    
    if (result.response.data) {
      console.log(`üìä Datos disponibles: S√≠`);
    }
    
    return { success: true, result, processingTime };
    
  } catch (error) {
    const processingTime = Date.now() - startTime;
    
    console.log(`\n‚ùå ERROR (${processingTime}ms):`);
    console.log(`‚ö†Ô∏è Tipo: ${error.name}`);
    console.log(`üìù Mensaje: ${error.message}`);
    
    return { success: false, error, processingTime };
  }
}

/**
 * Pruebas de modo conversacional
 */
async function testConversationalMode() {
  console.log(`\n${'üó£Ô∏è  MODO CONVERSACIONAL'.padEnd(80, 'üó£Ô∏è')}`);
  
  const conversationalTests = [
    {
      query: "hola",
      description: "Saludo b√°sico"
    },
    {
      query: "¬øqu√© puedes hacer?",
      description: "Pregunta sobre capacidades"
    },
    {
      query: "ayuda",
      description: "Solicitud de ayuda"
    },
    {
      query: "gracias, eso est√° perfecto",
      description: "Agradecimiento casual"
    },
    {
      query: "buenos d√≠as",
      description: "Saludo formal"
    },
    {
      query: "¬øc√≥mo funciona esto?",
      description: "Pregunta sobre funcionamiento"
    }
  ];
  
  const results = [];
  
  for (const test of conversationalTests) {
    const result = await testQuery(test.query, test.description);
    results.push({ ...test, ...result });
    
    // Pausa peque√±a entre pruebas
    await new Promise(resolve => setTimeout(resolve, 500));
  }
  
  return results;
}

/**
 * Pruebas de modo ag√©ntico
 */
async function testAgentialMode() {
  console.log(`\n${'ü§ñ MODO AG√âNTICO'.padEnd(80, 'ü§ñ')}`);
  
  const agentialTests = [
    {
      query: "busca en twitter sobre guatemala",
      description: "B√∫squeda en Twitter - Laura",
      expectedAgent: "Laura",
      expectedIntent: "nitter_search"
    },
    {
      query: "analiza el sentimiento en twitter sobre las elecciones",
      description: "An√°lisis de Twitter - Laura",
      expectedAgent: "Laura", 
      expectedIntent: "twitter_analysis"
    },
    {
      query: "busca el perfil de @jimmymoralesgt",
      description: "B√∫squeda de perfil - Laura",
      expectedAgent: "Laura",
      expectedIntent: "twitter_profile"
    },
    {
      query: "investiga sobre la situaci√≥n econ√≥mica de Guatemala",
      description: "B√∫squeda web - Laura",
      expectedAgent: "Laura",
      expectedIntent: "web_search"
    },
    {
      query: "busca en mi codex informaci√≥n sobre migraci√≥n",
      description: "B√∫squeda en Codex - Robert",
      expectedAgent: "Robert",
      expectedIntent: "search_codex"
    },
    {
      query: "¬øcu√°les son mis proyectos activos?",
      description: "Consulta de proyectos - Robert",
      expectedAgent: "Robert",
      expectedIntent: "search_projects"
    },
    {
      query: "analiza este documento sobre pol√≠tica",
      description: "An√°lisis de documento - Robert",
      expectedAgent: "Robert",
      expectedIntent: "analyze_document"
    },
    {
      query: "compara mis proyectos con las tendencias en twitter",
      description: "An√°lisis mixto - Varios agentes",
      expectedAgent: "Vizta",
      expectedIntent: "mixed_analysis"
    }
  ];
  
  const results = [];
  
  for (const test of agentialTests) {
    const result = await testQuery(test.query, test.description);
    
    // Validar expectativas
    if (result.success) {
      const response = result.result.response;
      const metadata = result.result.metadata;
      
      console.log(`\nüîç VALIDACI√ìN:`);
      console.log(`   Intenci√≥n esperada: ${test.expectedIntent} | Detectada: ${metadata.intent} ${metadata.intent === test.expectedIntent ? '‚úÖ' : '‚ùå'}`);
      console.log(`   Agente esperado: ${test.expectedAgent} | Usado: ${response.agent} ${response.agent === test.expectedAgent ? '‚úÖ' : '‚ùå'}`);
    }
    
    results.push({ ...test, ...result });
    
    // Pausa entre pruebas ag√©nticas
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
  
  return results;
}

/**
 * Pruebas de casos edge y ambiguos
 */
async function testEdgeCases() {
  console.log(`\n${'üîç CASOS EDGE'.padEnd(80, 'üîç')}`);
  
  const edgeTests = [
    {
      query: "dsdfsdfsdfsdf",
      description: "Texto sin sentido"
    },
    {
      query: "",
      description: "Query vac√≠o"
    },
    {
      query: "twitter guatemala projects analysis sentiment user profile",
      description: "M√∫ltiples keywords mezcladas"
    },
    {
      query: "¬øPuedes buscar en twitter informaci√≥n sobre mis proyectos y analizar documentos?",
      description: "Query complejo multi-intenci√≥n"
    },
    {
      query: "Hello, can you help me with Twitter analysis?",
      description: "Query en ingl√©s"
    }
  ];
  
  const results = [];
  
  for (const test of edgeTests) {
    const result = await testQuery(test.query, test.description);
    results.push({ ...test, ...result });
    
    await new Promise(resolve => setTimeout(resolve, 500));
  }
  
  return results;
}

/**
 * Generar reporte de resultados
 */
function generateReport(conversationalResults, agentialResults, edgeResults) {
  console.log(`\n${'üìä REPORTE FINAL'.padEnd(80, 'üìä')}`);
  
  const allResults = [...conversationalResults, ...agentialResults, ...edgeResults];
  const successful = allResults.filter(r => r.success);
  const failed = allResults.filter(r => !r.success);
  
  console.log(`\nüìà ESTAD√çSTICAS GENERALES:`);
  console.log(`   Total de pruebas: ${allResults.length}`);
  console.log(`   Exitosas: ${successful.length} (${((successful.length / allResults.length) * 100).toFixed(1)}%)`);
  console.log(`   Fallidas: ${failed.length} (${((failed.length / allResults.length) * 100).toFixed(1)}%)`);
  
  // Estad√≠sticas por modo
  const conversationalSuccess = conversationalResults.filter(r => r.success).length;
  const agentialSuccess = agentialResults.filter(r => r.success).length;
  const edgeSuccess = edgeResults.filter(r => r.success).length;
  
  console.log(`\nüìä ESTAD√çSTICAS POR MODO:`);
  console.log(`   Conversacional: ${conversationalSuccess}/${conversationalResults.length} (${((conversationalSuccess / conversationalResults.length) * 100).toFixed(1)}%)`);
  console.log(`   Ag√©ntico: ${agentialSuccess}/${agentialResults.length} (${((agentialSuccess / agentialResults.length) * 100).toFixed(1)}%)`);
  console.log(`   Casos Edge: ${edgeSuccess}/${edgeResults.length} (${((edgeSuccess / edgeResults.length) * 100).toFixed(1)}%)`);
  
  // Tiempo de procesamiento promedio
  const avgProcessingTime = allResults.reduce((sum, r) => sum + r.processingTime, 0) / allResults.length;
  console.log(`\n‚è±Ô∏è RENDIMIENTO:`);
  console.log(`   Tiempo promedio: ${avgProcessingTime.toFixed(0)}ms`);
  console.log(`   Tiempo m√°ximo: ${Math.max(...allResults.map(r => r.processingTime))}ms`);
  console.log(`   Tiempo m√≠nimo: ${Math.min(...allResults.map(r => r.processingTime))}ms`);
  
  // M√©todos de intenci√≥n utilizados
  const intentMethods = {};
  successful.forEach(r => {
    if (r.result && r.result.metadata && r.result.metadata.intentMethod) {
      const method = r.result.metadata.intentMethod;
      intentMethods[method] = (intentMethods[method] || 0) + 1;
    }
  });
  
  console.log(`\nüß† M√âTODOS DE CLASIFICACI√ìN:`);
  Object.entries(intentMethods).forEach(([method, count]) => {
    console.log(`   ${method}: ${count} veces (${((count / successful.length) * 100).toFixed(1)}%)`);
  });
  
  // Errores encontrados
  if (failed.length > 0) {
    console.log(`\n‚ùå ERRORES ENCONTRADOS:`);
    failed.forEach(r => {
      console.log(`   "${r.query}" ‚Üí ${r.error.name}: ${r.error.message}`);
    });
  }
  
  console.log(`\n${'‚úÖ REPORTE COMPLETADO'.padEnd(80, '‚úÖ')}`);
  
  return {
    total: allResults.length,
    successful: successful.length,
    failed: failed.length,
    successRate: (successful.length / allResults.length) * 100,
    avgProcessingTime,
    intentMethods
  };
}

/**
 * Funci√≥n principal de pruebas
 */
async function runTests() {
  console.log(`üöÄ INICIANDO PRUEBAS DEL SISTEMA LLM H√çBRIDO DE VIZTA`);
  console.log(`üë§ Usuario de prueba: ${TEST_USER.email}`);
  console.log(`üîó Session ID: ${SESSION_ID}`);
  console.log(`‚è∞ Inicio: ${new Date().toLocaleString()}`);
  
  try {
    // Ejecutar pruebas
    const conversationalResults = await testConversationalMode();
    const agentialResults = await testAgentialMode();
    const edgeResults = await testEdgeCases();
    
    // Generar reporte
    const report = generateReport(conversationalResults, agentialResults, edgeResults);
    
    return report;
    
  } catch (error) {
    console.error(`‚ùå Error ejecutando pruebas:`, error);
    throw error;
  }
}

/**
 * Modo interactivo
 */
async function interactiveMode() {
  const readline = require('readline');
  
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
  });
  
  console.log(`\nüéÆ MODO INTERACTIVO ACTIVADO`);
  console.log(`Escribe 'exit' para salir\n`);
  
  const askQuestion = () => {
    rl.question('üí¨ Tu consulta: ', async (query) => {
      if (query.toLowerCase() === 'exit') {
        console.log('¬°Hasta luego! üëã');
        rl.close();
        return;
      }
      
      if (query.trim()) {
        await testQuery(query, 'Consulta interactiva');
      }
      
      askQuestion();
    });
  };
  
  askQuestion();
}

// Verificar argumentos de l√≠nea de comandos
const args = process.argv.slice(2);

if (args.includes('--interactive')) {
  interactiveMode().catch(console.error);
} else if (args.includes('--quick')) {
  // Prueba r√°pida con solo algunos casos
  testQuery("hola").then(() => {
    return testQuery("busca en twitter sobre guatemala");
  }).catch(console.error);
} else {
  // Ejecutar suite completa
  runTests().catch(console.error);
}

module.exports = {
  testQuery,
  runTests,
  interactiveMode
}; 